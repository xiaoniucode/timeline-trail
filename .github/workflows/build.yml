name: Dockeré•œåƒæ„å»ºå’Œå‘å¸ƒ

on:
  workflow_dispatch:    # ğŸ® æ‰‹åŠ¨è§¦å‘
  push:
    tags:
      - 'v*'           # ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾è§¦å‘
env:
  # docker é¡¹ç›®ä»“åº“
  DOCKER_REPOSITORY: 'xiaoniucode/timeline-trail'

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - uses: actions/checkout@v4

      # 2. è®¾ç½® Java ç¯å¢ƒ
      - name: è®¾ç½® JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: maven

      # 3. æ„å»ºJARåŒ…
      - name: Mavenæ‰“åŒ…jar
        run: mvn clean package -DskipTests

      # 4. ç™»å½•åˆ° Docker Hub
      - name: ç™»å½•åˆ° Docker Hub
        run: |
          echo "ç™»å½•åˆ° Docker Hub..."
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      # 5. æå–ç‰ˆæœ¬æ ‡ç­¾
      - name: ä»tagsä¸­æå–ç‰ˆæœ¬å·
        id: version
        run: |
          # ä»æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·ï¼Œå¦‚ v0.1.0
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      # 6. æ„å»ºå’Œæ¨é€ Docker é•œåƒ
      - name: æ„å»ºdockeré•œåƒå¹¶å‘å¸ƒåˆ°docker hubå…¬å¼€ä»“åº“
        run: |
          # æå–ç‰ˆæœ¬å·
          VERSION="${{ steps.version.outputs.version }}"

          echo "å¼€å§‹æ„å»º Docker é•œåƒ..."
          echo "ç‰ˆæœ¬å·: $VERSION"
          echo "Docker é•œåƒ: ${{ env.DOCKER_REPOSITORY }}"

          # æ„å»ºé•œåƒ
          docker build . \
            --file Dockerfile \
            --tag ${{ env.DOCKER_REPOSITORY }}:latest \
            --tag ${{ env.DOCKER_REPOSITORY }}:$VERSION

          # æ¨é€é•œåƒåˆ° Docker Hub
          echo "æ¨é€é•œåƒåˆ° Docker Hub..."
          docker push ${{ env.DOCKER_REPOSITORY }}:latest
          docker push ${{ env.DOCKER_REPOSITORY }}:$VERSION

          echo "é•œåƒå·²æ¨é€åˆ° Docker Hub:"
          echo "   - ${{ env.DOCKER_REPOSITORY }}:latest"
          echo "   - ${{ env.DOCKER_REPOSITORY }}:$VERSION"
